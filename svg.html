<html>
    <script type="text/javascript">
(function() {
    window.onload = init;

    function init() {
        var notStrict = false;
        const svgBase = document.getElementById('svg_base');
        const backGrid = document.getElementById('backgrid');
        const setting = {
            width: 880,
            height: 780,
            size: 5
        };
        let c = 0;
        const cells = [];
        function initGrid() {
            backGrid.appendChild(svgLine(40, 390, 840, 390, 'grid_line'));
            backGrid.appendChild(svgLine(640, 40, 240, 740, 'grid_line'));
            backGrid.appendChild(svgLine(240, 40, 640, 740, 'grid_line'));
            for (var i = 1; i <= setting.size; i ++) {
                backGrid.appendChild(svgLine(40 + 40 * i, 390 + 70 * i, 840 - 40 * i, 390 + 70 * i, 'grid_line'));
                backGrid.appendChild(svgLine(40 + 40 * i, 390 - 70 * i, 840 - 40 * i, 390 - 70 * i, 'grid_line'));
                backGrid.appendChild(svgLine(640 + 40 * i, 40 + 70 * i, 240 + 80 * i, 740, 'grid_line'));
                backGrid.appendChild(svgLine(640 - 80 * i, 40, 240 - 40 * i, 740 - 70 * i, 'grid_line'));
                backGrid.appendChild(svgLine(240 - 40 * i, 40 + 70 * i, 640 - 80 * i, 740, 'grid_line'));
                backGrid.appendChild(svgLine(240 + 80 * i, 40, 640 + 40 * i, 740 - 70 * i, 'grid_line'));
            }
        }

        function svgLine(x1, y1, x2, y2, cssClass) {
            let ret = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            ret.setAttribute("x1", x1);
            ret.setAttribute("y1", y1);
            ret.setAttribute("x2", x2);
            ret.setAttribute("y2", y2);
            ret.setAttribute("class", cssClass);
            return ret;
        }
        function svgCell(x, y, cssClass, pos) {
            let ret = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            ret.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '#cell');
            ret.setAttribute('transform', `translate(${x},${y})`);
            ret.setAttribute("class", cssClass);
            ret.onclick = cellClickEvent(pos);
            return ret;
        }
        function cellClickEvent(pos) {
            return function() {
                if (getColorClass(pos.x, pos.y) == 'none') {
                    setColor(pos.x, pos.y, c);
                    var rev = revAll(pos.x, pos.y);
                    if (! rev) {
                        setColorClass(pos.x, pos.y, 'none');
                    } else {
                        c ++;
                        c = c % 3;
                    }
                }
            }
        }
        function revAll(x, y) {
            let myColorClass = getColorClass(x, y);
            let ret = false;
            ret = revIf({dx: -2, dy: 0}) || ret;
            ret = revIf({dx: -1, dy: -1}) || ret;
            ret = revIf({dx: -1, dy: 1}) || ret;
            ret = revIf({dx: 1, dy: -1}) || ret;
            ret = revIf({dx: 2, dy: 0}) || ret;
            ret = revIf({dx: 1, dy: 1}) || ret;
            return ret;

            function revIf(d) {
                let tx = x + d.dx;
                let ty = y + d.dy;
                let ret = false;

                let bColor = getColorClass2(tx, ty);
                if (bColor == 'none' || bColor == myColorClass || bColor == 'am') {
                    return false;
                } else {
                    let nextTx = tx + d.dx;
                    let nextTy = ty + d.dy;
                    if (seek(nextTx, nextTy)) {
                        reverse(tx, ty);
                        ret = true;
                    }
                    return ret;
                }
                function seek(nx, ny) {
                    let cColor = getColorClass2(nx, ny);
                    if (cColor == 'none') {
                        return false;
                    } else if (cColor == myColorClass || cColor == 'am') {
                        return true;
                    } else if (cColor == bColor || notStrict) {
                        return seek(nx + d.dx, ny + d.dy);
                    } else {
                        return false;
                    }
                }
                function reverse(nx, ny) {
                    let tx = nx;
                    let ty = ny;
                    while (true) {
                        let theColor = getColorClass(tx, ty);
                        if (myColorClass == theColor || theColor == 'am') {
                            return;
                        }
                        setColorClass(tx, ty, myColorClass);
                        tx += d.dx;
                        ty += d.dy;
                    }
                }
            }
        }
        function initCells() {
            let yMax = setting.size * 2 + 1;
            let center = setting.size;
            for (var y = 0; y < yMax; y ++) {
                let start = Math.abs(center - y);
                let width = yMax - start;
                let line = [];
                line.length = 4 * center;
                for (var xx = 0; xx < width * 2; xx += 2) {
                    let x = xx + start;
                    let cell = svgCell(40 + x * 40, 35 + y * 70, 'none', {x:x, y:y});
                    svgBase.appendChild(cell);
                    line[x] = cell;
                }
                cells.push(line);
            }
            setColor(10, 5, 99);
            setColor(8, 5, 0);
            setColor(12, 5, 0);
            setColor(10, 3, 0);
            setColor(9, 4, 1);
            setColor(11, 6, 1);
            setColor(7, 6, 1);
            setColor(11, 4, 2);
            setColor(9, 6, 2);
            setColor(13, 6, 2);
        }

        function setColor(x, y, colIndex) {
            var abc = colIndex == 0 ? 'a' : colIndex == 1 ? 'b' : colIndex == 2 ? 'c' : 'am';
            setColorClass(x, y, abc);
        }
        function setColorClass(x, y, abc) {
            cells[y][x].setAttribute('class', abc)
        }
        function getColorClass2(x, y) {
            if (x < 0 || y < 0
                || y >= cells.length
                || x >= cells[y].length
                || ! cells[y][x]) {
                return 'none';
            } else {
                return getColorClass(x, y);
            }
        }
        function getColorClass(x, y) {
            return cells[y][x].getAttribute('class');
        }

        initGrid();
        initCells();
    }
})();
    </script>
    <body >
        <svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink="http://www.w3.org/1999/xlink"
            width='880' height='780' viewBox='0 0 880 780'
            id='svg_base'>
            <defs>
                <style>
                    svg {
                        background: #ddd;
                    }
                    .grid_line {
                        stroke: #aaa;
                        stroke-width: 1;
                    }
                    .none:hover { fill: #888; }
                    .none { fill: #aaa; }
                    .a { fill: #c88; }
                    .b { fill: #8c8; }
                    .c { fill: #88c; }
                    .am {
                        stroke: none;
                        animation: allmighty 1s infinite linear;
                        -webkit-animation: allmighty 1s infinite linear;
                    }
                    @-webkit-keyframes allmighty {
                          0% { fill: #c88; }
                         33% { fill: #8c8; }
                         66% { fill: #88c; }
                        100% { fill: #c88; }
                    }
                </style>
                <g id='cell'>
                    <circle x='0' y='0' r='20'/>
                </g>
            </defs>
            <g id='backgrid'>
            </g>
        </svg>
    </body>
</html>
